<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Solana Token Multisender</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    #log-output::-webkit-scrollbar { width:4px; }
    #log-output::-webkit-scrollbar-track { background:#334155; }
    #log-output::-webkit-scrollbar-thumb { background:#64748b; border-radius:4px; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans p-4 md:p-8 min-h-screen">
  <div class="max-w-4xl mx-auto">
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Solana Token Multisender</h1>
      <p class="text-slate-400">Connect your wallet, paste the mint address, and send to many recipients.</p>
    </header>

    <div class="bg-yellow-900 border border-yellow-700 text-yellow-100 px-4 py-3 rounded-lg mb-6 shadow" role="alert">
      <p class="font-bold">Use at Your Own Risk!</p>
      <p class="text-sm">Always test on Devnet before Mainnet. Verify all addresses and amounts.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Left: inputs -->
      <div class="bg-slate-800 p-6 rounded-lg shadow flex flex-col gap-6">
        <div>
          <h2 class="text-lg font-semibold mb-2">1. Connect Wallet & Select Cluster</h2>
          <button id="connect-wallet-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">
            Connect Wallet
          </button>
          <select id="cluster-select" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2 mt-2">
            <option value="https://api.devnet.solana.com">Devnet (Testing)</option>
            <option value="https://api.mainnet-beta.solana.com">Mainnet-beta (Real Funds)</option>
          </select>
          <p id="connect-hint" class="text-xs text-slate-400 mt-1">Please connect your wallet first to enable the form.</p>
        </div>

        <div>
          <label for="token-mint-address" class="block text-sm font-medium text-slate-300 mb-1">2. Token Mint Address</label>
          <input id="token-mint-address" type="text" disabled
                 autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text"
                 class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2"
                 placeholder="Base58 mint address (e.g., EPjFW...)">
        </div>

        <div>
          <label for="batch-size" class="block text-sm font-medium text-slate-300 mb-1">3. Transfers per Transaction (Batch Size)</label>
          <input id="batch-size" type="number" value="6" min="1" max="12" disabled
                 class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2">
          <p class="text-xs text-slate-400 mt-1">If creating many ATAs, use 3–6 to avoid tx size limits.</p>
        </div>

        <div>
          <label for="recipients-list" class="block text-sm font-medium text-slate-300 mb-1">4. Recipients (one per line: Address, Amount)</label>
          <textarea id="recipients-list" rows="10" disabled
            class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2 font-mono text-sm"
            placeholder="Address, Amount
Address, Amount
Example:
Hc4q...abcd, 10.5
CxtR...wxyz, 2"></textarea>
        </div>

        <button id="send-btn" disabled
          class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition disabled:bg-gray-500">
          Connect Wallet to Start
        </button>
      </div>

      <!-- Right: log -->
      <div class="bg-slate-800 p-6 rounded-lg shadow flex flex-col">
        <h2 class="text-lg font-semibold mb-2 text-white">Log & Progress</h2>
        <div id="log-output"
             class="w-full h-96 bg-slate-900 rounded-lg p-4 font-mono text-sm text-slate-300 overflow-y-auto whitespace-pre-wrap break-words">
          Welcome! Connect your wallet to begin.
        </div>
        <button id="clear-log-btn"
                class="mt-4 bg-slate-600 hover:bg-slate-700 text-white text-sm py-2 px-4 rounded-lg transition">
          Clear Log
        </button>
      </div>
    </div>

    <footer class="text-center text-slate-500 mt-8 text-sm">Simplified ESM version.</footer>
  </div>

  <!-- Use ESM imports to avoid global splToken/solanaWeb3 issues -->
  <script type="module">
    import { Connection, PublicKey, Transaction } from 'https://esm.sh/@solana/web3.js@1.95.3';
    import {
      getMint,
      getAssociatedTokenAddress,
      createAssociatedTokenAccountInstruction,
      createTransferCheckedInstruction,
      TOKEN_PROGRAM_ID,
      TOKEN_2022_PROGRAM_ID,
      ASSOCIATED_TOKEN_PROGRAM_ID,
    } from 'https://esm.sh/@solana/spl-token@0.4.6';

    // UI
    const connectBtn      = document.getElementById('connect-wallet-btn');
    const clusterSelect   = document.getElementById('cluster-select');
    const mintInput       = document.getElementById('token-mint-address');
    const recipientsInput = document.getElementById('recipients-list');
    const batchSizeInput  = document.getElementById('batch-size');
    const sendBtn         = document.getElementById('send-btn');
    const hint            = document.getElementById('connect-hint');
    const clearLogBtn     = document.getElementById('clear-log-btn');
    const logOutput       = document.getElementById('log-output');

    let provider = null; // Phantom
    let wallet   = null; // PublicKey
    let connection = null;

    function log(msg, type='info') {
      const ts = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-slate-300');
      logOutput.innerHTML += `\n<div class="${color}"><span class="text-slate-500">${ts}:</span> ${msg}</div>`;
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    clearLogBtn.addEventListener('click', () => { logOutput.innerHTML = 'Log cleared.'; });

    function setUi(connected) {
      mintInput.disabled       = !connected;
      recipientsInput.disabled = !connected;
      batchSizeInput.disabled  = !connected;
      sendBtn.disabled         = !connected;
      sendBtn.textContent      = connected ? 'Prepare & Send Transactions' : 'Connect Wallet to Start';
      hint.textContent         = connected ? 'Wallet connected. Enter mint & recipients.' : 'Please connect your wallet first to enable the form.';
    }

    // Minimal format validation on blur (optional)
    mintInput.addEventListener('blur', () => {
      const v = mintInput.value.trim();
      if (!v) return;
      try {
        const pk = new PublicKey(v);
        log(`Mint format OK: ${pk.toString()}`);
      } catch {
        log('Invalid mint address (not Base58 Solana public key).', 'error');
      }
    });

    // Connect wallet (Phantom)
    connectBtn.addEventListener('click', async () => {
      const injected = window.phantom?.solana || window.solana;
      if (!injected || !injected.isPhantom) {
        log('Phantom wallet not found. Install: https://phantom.app/', 'error');
        window.open('https://phantom.app/', '_blank');
        return;
      }
      try {
        provider = injected;
        log('Requesting wallet connection...', 'info');
        const res = await provider.connect(); // popup
        wallet = provider.publicKey || res?.publicKey;
        if (!wallet) throw new Error('No public key returned.');
        log('Wallet connected.', 'success');
        log(`Address: ${wallet.toString()}`);
        connectBtn.textContent = `Connected: ${wallet.toString().slice(0,4)}...${wallet.toString().slice(-4)}`;
        connectBtn.classList.replace('bg-indigo-600','bg-slate-700');
        setUi(true);

        if (provider.on) {
          provider.on('disconnect', () => {
            log('Wallet disconnected.', 'error');
            wallet = null; provider = null;
            connectBtn.textContent = 'Connect Wallet';
            connectBtn.classList.replace('bg-slate-700','bg-indigo-600');
            setUi(false);
          });
        }
      } catch (e) {
        const msg = e?.message || String(e);
        if (e?.code === 4001) log('User rejected connection.', 'error');
        else log(`Connect error: ${msg}`, 'error');
      }
    });

    function resetSendBtn() {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Prepare & Send Transactions';
    }

    // BigInt helpers
    function decimalToAmount(str, decimals) {
      const s = String(str).trim();
      if (!/^\d+(?:\.\d+)?$/.test(s)) throw new Error(`Invalid amount: ${str}`);
      const [whole, fracRaw=''] = s.split('.');
      const frac = (fracRaw + '0'.repeat(decimals)).slice(0, decimals);
      return BigInt(whole + frac);
    }
    function formatAmount(bi, decimals) {
      const s = bi.toString();
      if (decimals === 0) return s;
      const pad = s.padStart(decimals+1,'0');
      const whole = pad.slice(0,-decimals);
      const frac  = pad.slice(-decimals).replace(/0+$/,'');
      return frac ? `${whole}.${frac}` : whole;
    }

    // Send logic
    sendBtn.addEventListener('click', async () => {
      if (!wallet) { log('Connect wallet first.', 'error'); return; }

      sendBtn.disabled = true;
      sendBtn.textContent = 'Processing...';
      log('Starting bulk send process...');

      const clusterUrl = clusterSelect.value;
      const mintStr    = mintInput.value.trim();
      const listStr    = recipientsInput.value.trim();
      const batchSize  = parseInt(batchSizeInput.value,10);

      if (!mintStr) { log('Mint address required.', 'error'); resetSendBtn(); return; }
      if (!listStr)  { log('Recipients list empty.', 'error'); resetSendBtn(); return; }
      if (isNaN(batchSize) || batchSize <= 0 || batchSize > 12) {
        log('Batch size 1–12 required.', 'error'); resetSendBtn(); return;
      }

      let mintPubkey, tokenProgramId = TOKEN_PROGRAM_ID, decimals = 0, senderAta;

      try {
        log(`Connecting RPC: ${clusterUrl}`);
        connection = new Connection(clusterUrl, 'confirmed');
        mintPubkey = new PublicKey(mintStr);

        // Detect token program by mint owner
        const mintAcct = await connection.getAccountInfo(mintPubkey, 'confirmed');
        if (!mintAcct) throw new Error('Mint account not found on this cluster.');
        const token2022 = TOKEN_2022_PROGRAM_ID ?? TOKEN_PROGRAM_ID;
        tokenProgramId = mintAcct.owner?.toString() === token2022.toString() ? token2022 : TOKEN_PROGRAM_ID;
        log(`Program: ${tokenProgramId.toString() === TOKEN_PROGRAM_ID.toString() ? 'SPL Token (legacy)' : 'Token-2022'}`);

        const mintInfo = await getMint(connection, mintPubkey, 'confirmed', tokenProgramId);
        decimals = mintInfo.decimals;
        log(`Decimals: ${decimals}`);

        // Derive sender ATA
        senderAta = await getAssociatedTokenAddress(
          mintPubkey,
          wallet,
          false,
          tokenProgramId,
          ASSOCIATED_TOKEN_PROGRAM_ID
        );
        log(`Sender ATA: ${senderAta.toString()}`);

        // Create sender ATA if missing
        const senderInfo = await connection.getAccountInfo(senderAta, 'confirmed');
        if (!senderInfo) {
          log('Sender ATA missing, creating...');
          const txCreate = new Transaction();
          const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash('confirmed');
          txCreate.recentBlockhash = blockhash;
          txCreate.feePayer = wallet;
          txCreate.add(
            createAssociatedTokenAccountInstruction(
              wallet, senderAta, wallet, mintPubkey, tokenProgramId, ASSOCIATED_TOKEN_PROGRAM_ID
            )
          );
          const signedCreate = await provider.signTransaction(txCreate);
          const sigCreate = await connection.sendRawTransaction(signedCreate.serialize(), { skipPreflight:false });
          log(`Sender ATA creation tx: ${sigCreate}`, 'success');
          await connection.confirmTransaction({ signature:sigCreate, blockhash, lastValidBlockHeight }, 'confirmed');
          log('Sender ATA confirmed.', 'success');
        }

        // Parse recipients
        log('Parsing recipients...');
        const lines = listStr.split('\n').filter(l => l.trim() !== '');
        const recipients = [];
        for (const [i, raw] of lines.entries()) {
          const parts = raw.split(',').map(s => s.trim());
          if (parts.length !== 2) throw new Error(`Invalid line #${i+1}: "${raw}"`);
          const [addrStr, amtStr] = parts;
          let pk;
          try { pk = new PublicKey(addrStr); }
          catch { throw new Error(`Bad address line #${i+1}: ${addrStr}`); }
          const amount = decimalToAmount(amtStr, decimals);
          if (amount <= 0n) throw new Error(`Amount must be > 0 line #${i+1}`);
          recipients.push({ address: pk, amount });
        }
        log(`Recipients parsed: ${recipients.length}`);
        const total = recipients.reduce((s,r)=>s+r.amount, 0n);
        log(`Total tokens: ${formatAmount(total, decimals)}`);

        // Batch
        const batches = [];
        for (let i=0;i<recipients.length;i+=batchSize) batches.push(recipients.slice(i,i+batchSize));
        log(`Batches: ${batches.length}`);

        // Process batches
        for (let i=0;i<batches.length;i++) {
          const batch = batches[i];
          log(`-- Batch ${i+1}/${batches.length} --`);
          const tx = new Transaction();
          const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash('confirmed');
          tx.recentBlockhash = blockhash;
          tx.feePayer = wallet;

          for (const r of batch) {
            const destAta = await getAssociatedTokenAddress(
              mintPubkey, r.address, false, tokenProgramId, ASSOCIATED_TOKEN_PROGRAM_ID
            );
            const destInfo = await connection.getAccountInfo(destAta, 'confirmed');
            if (!destInfo) {
              tx.add(
                createAssociatedTokenAccountInstruction(
                  wallet, destAta, r.address, mintPubkey, tokenProgramId, ASSOCIATED_TOKEN_PROGRAM_ID
                )
              );
              log(`  + Create ATA for ${r.address.toString().slice(0,4)}...`);
            }
            tx.add(
              createTransferCheckedInstruction(
                senderAta, mintPubkey, destAta, wallet, r.amount, decimals, [], tokenProgramId
              )
            );
            log(`  + Transfer ${formatAmount(r.amount, decimals)} to ${r.address.toString().slice(0,4)}...`);
          }

          log('Signing batch transaction...');
          const signed = await provider.signTransaction(tx);
          log('Sending batch transaction...');
          const sig = await connection.sendRawTransaction(signed.serialize(), { skipPreflight:false });
          log(`TX sent: ${sig}`, 'success');
          log('Confirming...');
          const conf = await connection.confirmTransaction({ signature:sig, blockhash, lastValidBlockHeight }, 'confirmed');
          if (conf?.value?.err) throw new Error(`Failure: ${JSON.stringify(conf.value.err)}`);
          const devnetParam = clusterUrl.includes('devnet') ? '?cluster=devnet' : '';
          log(`Batch ${i+1} confirmed. Explorer: https://solscan.io/tx/${sig}${devnetParam}`, 'success');
        }

        log('All batches complete.', 'success');
      } catch (err) {
        log(`Error: ${err?.message || String(err)}`, 'error');
        if (err?.stack) log(err.stack,'error');
      } finally {
        resetSendBtn();
      }
    });
  </script>
</body>
</html>
